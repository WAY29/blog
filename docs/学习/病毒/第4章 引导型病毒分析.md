# 第4章 引导型病毒分析
## 硬盘物理结构
![](https://gitee.com/guuest/images/raw/master/img/20210616171140.png)
![](https://gitee.com/guuest/images/raw/master/img/20210616171455.png)
![](https://gitee.com/guuest/images/raw/master/img/20210618131936.png)

现在的硬盘主要包括：盘片、磁头、盘主轴、控制电机、磁头控制器、数据转换器、接口、缓存等几个部份。
硬盘上所有的盘片都固定在⼀个旋转轴上，这个轴即盘片主轴。其中所有盘片之间是绝对平行的，在每个盘片的存储⾯上都有⼀个磁头，磁头与盘片之间的距离比头发丝的直径还要小。
所有的磁头都连在⼀个磁头控制器上，由磁头控制器负责各个磁头的运动。

## 硬盘参数
CHS（Cylinder/Head/Sector）参数
磁头数（Heads）表示硬盘总共有几个磁头，也就是有几面盘片，最大为255（用8个二进制位存储）
柱面数（Cylinders）表示硬盘每一面盘片上有几条磁道，最大为1023（用10个二进制位存储）；扇区数（Sectors）表示每一条磁道上有几个扇区，最大为63（用6个二进制位存储），每个扇区一般是512个字节
磁盘最大容量
255*1023*63*512/1048576=8024MB（1M=1048576 Bytes）
或硬盘厂商常用的单位：255*1023*63*512/1000000=8414MB（1M=1000000 Bytes）

## 硬盘的数据存储结构
硬盘由很多盘片(platter)组成，每个盘片的每个⾯都有⼀个读写磁头。如果有N个盘片。就有 2N个⾯，对应2N个磁头(Heads)，从0、1、2开始编号。 
每个盘片被划分成若干个同心圆磁道(逻辑上的，是不可见的)，每个盘片的划分规则通常是一样的。这样每个盘片的半径均为固定值R的同心圆再逻辑上形成了⼀个以电机主轴为轴的柱面 (Cylinders)，从外至里编号为0、1、2…… 
每个盘片上的每个磁道⼜被划分为几十个扇区(Sector)，通常的容量是512byte，并按照⼀定规则编号为1、2、3…… 
形成Cylinders×Heads×Sector个扇区。
## 主引导扇区
![](https://gitee.com/guuest/images/raw/master/img/20210616201945.png)
### 解释
主引导记录（Master Boot Record，MBR）（446字节）
主引导程序（位移量000~1BDH），用于硬盘启动时将系统控制转给用户指定的并在分区中登记了的某个操作系统区。
主分区表（磁盘分区表）（4个分区表项，每个16字节）（Partition Table，位移量1BE-1FDH），用于指明硬盘划分情况，含4个可能的分区，每个分区的记录占用16个字节，由FDISK程序建立。
引导扇区标记（Boot Record ID/Signature）（2字节）
01FE：55
01FF：AA
### 主引导记录包含内容
硬盘的主引导记录扇区，即0⾯0柱1扇区，是⼀个系统的隐含扇区。
①主引导程序代码
主引导程序⽤来找出系统当前的活动分区，负责把对应的⼀个操作系统的引导记录(当前活动分区的引导记录)装入内存，然后把控制权转给该分区的引导记录。
②分区表
主引导扇区的分区表存放在主引导记录的后半部分。分区表可分为4个部分(DOS3.2以下版本) 表示4个分区的信息。从位移量1BEH开始的64个字节是硬盘分区表
③主引导记录结束标志 当主引导记录结束标志为AA55H时，表示该主引导记录是⼀⼀个有效的记录，它可⽤来引导 硬盘系统。


## 技术方法
提醒注意：启动过程中，有一关键细节：ROM BIOS在读引导扇区至内存0000：7C00处执行时，对引导扇区的合法性并未做检查，而是简单的、机械的读入执行。
引导型病毒就利用了DOS启动的这一弱点，使病毒程序先于正常的DOS引导程序获得控制。

### 常驻内存高端
⽬的：想办法把病毒程序载⼊到内存中，载⼊后保证这⼀段代码不被其他代码覆盖。
内存0000:0413处两字节描述了基本内存的大小，它的值是KB的倍数。
病毒程序首先将自身复制到内存的高端，修改内存容量标志单元，在原有值的基础上减去病毒长度，使得病毒代码能够常驻内存；
然后将原int 13h磁盘中断服务程序的中断向量保存，并修改此中断向量，将其指向病毒代码，病毒代码因此获得系统控制权，进而执行感染、破坏等工作。
#### 修改中断向量表，截获系统中断
![](https://gitee.com/guuest/images/raw/master/img/20210616203808.png)
